// extended text features, (c) Martin Kelm, 2013
var extendedText={defaults:{key:{ctrl:17,v:86,space:32,enter:13},pattern:{url:/(\b(((?:ht|f)tps?:\/\/)|www\.)[a-z0-9-._~!$\'()*+,;=:\/?#[\]@%]+(?:(?!&(?:gt|\#0*62|\#x0*3e);|&(?:amp|apos|quot|\#0*3[49]|\#x0*2[27]);[.!&\',:?;]?(?:[^a-z0-9\-._~!$&\'()*+,;=:\/?#[\]@%]|$))&[a-z0-9\-._~!$\'()*+,;=:\/?#[\]@%]*)*[a-z0-9\-_~$()*+=\/#[\]@%])/gim,image:/(\.(jpg|jpeg|gif|png))/gim,video:/youtube\.com\/watch\?(.*)?v=([a-zA-Z0-9\-_]+)|vimeo\.com\/([0-9]+)/gim}},options:{elementType:"",elementSelector:"",firstUrl:{url:!1,image:!1,video:!0},urlHandler:{image:"",video:""},preloaderImage:{image:"",video:""}},temp:{ctrlDown:!1,pasteEvent:!1,pastePosStart:0},urlCache:[],urlCacheImgs:[],urlCacheVideos:[],urlsSubmitted:!1,onLoad:function(e){var t=e.options,i=e.defaults;t.urlHandler.image=$(t.elementSelector).parents("form:first").children('input[name *= "image_handler_url"]:first').val(),t.urlHandler.video=$(t.elementSelector).parents("form:first").children('input[name *= "video_handler_url"]:first').val(),(void 0!=t.urlHandler.video||void 0!=t.urlHandler.image)&&(t.preloaderImage.image=$(t.elementSelector).parents("div:first").children("form ~ p."+t.elementType+"-form-thumbnails").attr("data-preloader-image"),t.preloaderImage.video=$(t.elementSelector).parents("div:first").children("form ~ p."+t.elementType+"-form-videos").attr("data-preloader-image"),$(t.elementSelector).parents("form:first").children('button[type = "submit"]:first').click(function(){return e.urlsSubmitted=!0,!0}),$(t.elementSelector).keyup(function(t){if(t.keyCode==i.key.space||t.keyCode==i.key.enter){var n=$(this).val().replace("\r\n","\n").split("\n");t.keyCode==i.key.enter&&n.splice(n.length-1,1);var a=n.pop();if(t.keyCode==i.key.enter)var o=a.length,r=0;else var o=a.length-1,r=0;for(var s=o;s>0;s--){var l=a.substring(s-1,s);" "==l&&(r=s,s=0)}o>r&&e.detectUrlFromText(e,a.substring(r,o))}}),$(t.elementSelector).keydown(function(t){t.keyCode==i.key.ctrl&&(e.temp.ctrlDown=!0)}).keyup(function(t){t.keyCode==i.key.ctrl&&(e.temp.ctrlDown=!1)}),$(t.elementSelector).keydown(function(t){if(1==e.temp.ctrlDown&&t.keyCode==i.key.v){e.temp.pasteEvent=!0;var n=$(this).val(),a=$(this).selection("getPos");e.temp.pastePosStart=a.end>a.start?a.start:""==n?0:n.length}}).keyup(function(){if(1==e.temp.pasteEvent){var t=$(this).val();e.detectUrlFromText(e,t.substring(e.temp.pastePosStart,t.length)),e.temp.pasteEvent=!1}}),$(window).on("beforeunload",function(){0==e.urlsSubmitted&&(e.urlCacheImgs.length>0&&$.ajax({url:e.opts.urlHandler.image,async:!1}),e.urlCacheVideos.length>0&&$.ajax({url:e.opts.urlHandler.video,async:!1}))}))},replaceVideoPreviewImage:function(e){return $(e).parents("div.video-preview-image:first").html($(e).parents("div.video-preview-image:first").next().html().replace('" frameborder','&amp;autoplay=1" frameborder')),!1},detectUrlFromText:function(e,t){var i=t.match(e.defaults.pattern.url);if(i)for(var n=0;i.length>n;n++)"www."==i[n].substring(0,4)&&(i[n]="http://"+i[n]),e.performFurtherUrlDetection(e,i[n])},performFurtherUrlDetection:function(e,t){var i=e.defaults,n=e.options;if(-1==$.inArray(t,e.urlCache)&&-1==$.inArray(t,e.urlCacheImgs)&&-1==$.inArray(t,e.urlCacheVideos))if(void 0!=n.urlHandler.image&&t.match(i.pattern.image)){if(e.urlCacheImgs.length>0&&1==n.firstUrl.image)return!1;e.urlCacheImgs.push(t);var a=n.urlHandler.image.replace(encodeURIComponent("{URL}"),encodeURIComponent(t));$(n.elementSelector).parents("div:first").children("form ~ p."+n.elementType+"-form-thumbnails").append('<img class="thumbnail pull-left" alt="" src="'+n.preloaderImage.image+'" />'),$.ajax({url:a}).done(function(e){$(n.elementSelector).parents("div:first").children("form ~ p."+n.elementType+"-form-thumbnails").children(".thumbnail:last").replaceWith($(e).children("requested-content").html())})}else if(void 0!=n.urlHandler.video&&t.match(i.pattern.video)){if(e.urlCacheVideos.length>0&&1==n.firstUrl.video)return!1;e.urlCacheVideos.push(t);var a=n.urlHandler.video.replace(encodeURIComponent("{URL}"),encodeURIComponent(t));$(n.elementSelector).parents("div:first").children("form ~ p."+n.elementType+"-form-videos").append('<div class="video-preview thumbnail"><img alt="" src="'+n.preloaderImage.video+'" />'+"</div>"),$.ajax({url:a}).done(function(e){$(n.elementSelector).parents("div:first").children("form ~ p."+n.elementType+"-form-videos").children(".thumbnail:last").replaceWith($(e).children("requested-content").html())})}},removeEventListeners:function(e){$(e.options.elementSelector).unbind("keydown"),$(e.options.elementSelector).unbind("keyup")}};